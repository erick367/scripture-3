# Uncomment this line to define a global platform for your project
platform :ios, '16.0'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure flutter pub get is executed first"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Generated.xcconfig, then run flutter pub get"
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks! :linkage => :static

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
  target 'RunnerTests' do
    inherit! :search_paths
  end
end

pre_install do |installer|
  # Workaround for CocoaPods issue with static frameworks
  # Bypasses the strict check for transitive static binary dependencies (like MediaPipe/TFLite)
  Pod::Installer::Xcode::TargetValidator.send(:define_method, :verify_no_static_framework_transitive_dependencies) {}
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    flutter_additional_ios_build_settings(target)
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
      
      # Force link Accelerate framework for image processing symbols (vImage)
      config.build_settings['OTHER_LDFLAGS'] ||= '$(inherited)'
      config.build_settings['OTHER_LDFLAGS'] << ' -framework Accelerate'

      # Ensure arm64 is NOT excluded for simulators (Fixes Apple Silicon simulator issues)
      config.build_settings.delete 'EXCLUDED_ARCHS'
      config.build_settings['SUPPORTED_PLATFORMS'] = 'iphoneos iphonesimulator'
      
      # CRITICAL: Prevent symbol stripping that breaks TensorFlow Lite in release builds
      # Without this, TFLite crashes on app launch in release mode
      config.build_settings['STRIP_STYLE'] = 'non-global'
    end
  end

  # FIX: SQLCipher umbrella header uses double quotes instead of angle brackets
  # This causes build errors in release mode
  sqlcipher_umbrella = Dir.glob("#{installer.sandbox.root}/Target Support Files/SQLCipher/SQLCipher-umbrella.h").first
  if sqlcipher_umbrella && File.exist?(sqlcipher_umbrella)
    content = File.read(sqlcipher_umbrella)
    if content.include?('#import "sqlite3.h"')
      fixed_content = content.gsub('#import "sqlite3.h"', '#import <sqlite3.h>')
      File.write(sqlcipher_umbrella, fixed_content)
      puts "✅ Patched SQLCipher umbrella header"
    end
  end

  # FIX: flutter_gemma podspec uses $(SRCROOT)/Pods which creates double Pods/Pods path
  # Replace with $(PODS_ROOT) which correctly resolves to ios/Pods
  flutter_gemma_configs = Dir.glob("#{installer.sandbox.root}/Target Support Files/flutter_gemma/*.xcconfig")
  flutter_gemma_configs.each do |config_path|
    content = File.read(config_path)
    if content.include?('$(SRCROOT)/Pods/TensorFlowLiteSelectTfOps')
      fixed_content = content.gsub('$(SRCROOT)/Pods/TensorFlowLiteSelectTfOps', '$(PODS_ROOT)/TensorFlowLiteSelectTfOps')
      File.write(config_path, fixed_content)
      puts "✅ Patched flutter_gemma xcconfig: #{File.basename(config_path)}"
    end
  end
end
